# Story 1.7: Protected Route Guard

<!-- Powered by BMAD™ Core -->

## Status
Done

---

## Story

**As a** developer,
**I want** all admin routes protected by authentication checks,
**so that** unauthenticated users cannot access the dashboard.

---

## Acceptance Criteria

1. Higher-order component or middleware created to protect routes (`/src/components/guards/ProtectedRoute.tsx`)
2. Protected route checks `isAuthenticated` from auth context
3. If not authenticated, user is redirected to `/login` with return URL parameter (e.g., `/login?returnTo=/dashboard`)
4. After successful login, user redirected to original return URL if present
5. Loading state shown while authentication status is being determined (avoid flash of login page)
6. All routes under `/dashboard/*`, `/incidents/*`, `/users/*`, `/categories/*`, `/profile/*` are protected
7. Public routes (`/login`, `/register`) remain accessible without authentication
8. If authenticated user navigates to `/login` or `/register`, redirect to `/dashboard`

---

## Tasks / Subtasks

- [ ] **Task 1: Create ProtectedRoute Higher-Order Component** (AC: 1, 2)
  - [ ] Create file `/src/components/guards/ProtectedRoute.tsx`
  - [ ] Import `useAuth` hook from `@/contexts/AuthContext`
  - [ ] Import `useRouter` and `usePathname` from `next/navigation`
  - [ ] Define `ProtectedRouteProps` interface with `children: React.ReactNode`
  - [ ] Access `isAuthenticated` and `isLoading` from auth context
  - [ ] Create component structure with authentication checks

- [ ] **Task 2: Implement Loading State** (AC: 5)
  - [ ] While `isLoading` is true, display loading spinner
  - [ ] Use `LoadingSpinner` component from `/src/components/common/LoadingSpinner.tsx`
  - [ ] Prevent rendering of protected content during loading
  - [ ] Prevent flash of login redirect during initial auth check

- [ ] **Task 3: Implement Redirect to Login with Return URL** (AC: 3)
  - [ ] If not authenticated after loading completes, redirect to `/login`
  - [ ] Use `usePathname()` to get current path
  - [ ] Encode current path as `returnTo` query parameter: `/login?returnTo=/dashboard`
  - [ ] Use `router.push()` to redirect with query parameter
  - [ ] Example: `router.push(\`/login?returnTo=${encodeURIComponent(pathname)}\`)`

- [ ] **Task 4: Update Login Page to Handle Return URL** (AC: 4)
  - [ ] Modify `/src/app/(auth)/login/page.tsx` to read `returnTo` query parameter
  - [ ] Import `useSearchParams` from `next/navigation`
  - [ ] After successful login, redirect to `returnTo` URL if present
  - [ ] If no `returnTo`, default to `/dashboard`
  - [ ] Example: `router.push(searchParams.get('returnTo') || '/dashboard')`

- [ ] **Task 5: Protect Dashboard Routes** (AC: 6)
  - [ ] Create dashboard layout at `/src/app/(dashboard)/layout.tsx` (if not exists)
  - [ ] Wrap layout content with `<ProtectedRoute>` component
  - [ ] Mark layout as client component with `"use client"` directive
  - [ ] All child routes will inherit protection: `/dashboard/*`, `/incidents/*`, `/users/*`, `/categories/*`, `/profile/*`

- [ ] **Task 6: Update Login and Register Pages to Redirect if Authenticated** (AC: 8)
  - [ ] Modify `/src/app/(auth)/login/page.tsx`
  - [ ] Add check: if `isAuthenticated` is true, redirect to `/dashboard`
  - [ ] Use `useEffect` with dependency on `isAuthenticated` and `isLoading`
  - [ ] Only redirect after loading completes to avoid race conditions
  - [ ] Apply same logic to `/src/app/(auth)/register/page.tsx`

- [ ] **Task 7: Create LoadingSpinner Component** (AC: 5)
  - [ ] Create file `/src/components/common/LoadingSpinner.tsx`
  - [ ] Use Lucide React `Loader2` icon with `animate-spin` class
  - [ ] Center spinner vertically and horizontally
  - [ ] Add optional `size` prop (default: medium)
  - [ ] Make component reusable for other loading states

- [ ] **Task 8: Test Protected Route Scenarios** (AC: All)
  - [ ] Test unauthenticated user accessing `/dashboard` → redirects to `/login?returnTo=/dashboard`
  - [ ] Test login from redirect → after login, redirects back to `/dashboard`
  - [ ] Test authenticated user accessing `/login` → redirects to `/dashboard`
  - [ ] Test authenticated user accessing `/register` → redirects to `/dashboard`
  - [ ] Test loading state displays without flash
  - [ ] Test all protected routes (`/incidents`, `/users`, `/categories`, `/profile`)
  - [ ] Test public routes remain accessible (`/login`, `/register`)

- [ ] **Task 9: Write Unit Tests for ProtectedRoute Component** (AC: All)
  - [ ] Create test file `/src/components/guards/ProtectedRoute.test.tsx`
  - [ ] Test: Loading state displays spinner
  - [ ] Test: Unauthenticated user redirects to `/login` with returnTo parameter
  - [ ] Test: Authenticated user renders children
  - [ ] Test: No flash of content during loading
  - [ ] Mock `useAuth` and `useRouter` hooks in tests
  - [ ] Run tests: `npm run test`

- [ ] **Task 10: Verification and Manual Testing** (AC: All)
  - [ ] Manually test complete authentication flow:
    - Logout if logged in
    - Try to access `/dashboard` → redirects to `/login?returnTo=/dashboard`
    - Login successfully → redirects back to `/dashboard`
    - Navigate to `/login` → immediately redirects to `/dashboard`
    - Logout and verify public routes accessible
  - [ ] Test protected routes work correctly (no unauthorized access)
  - [ ] Verify no flash of content during authentication check
  - [ ] Run `npm run lint` to ensure no ESLint errors
  - [ ] Run `npm run build` to verify production build succeeds

---

## Dev Notes

### Previous Story Insights

**Key Learnings from Story 1.4 (AuthContext)** [Source: docs/stories/1.4.story.md]
- AuthContext provides `isAuthenticated`, `isLoading`, `user`, and `token` state
- `useAuth()` custom hook available for accessing auth state in components
- `isLoading` is true during initial auth check (token validation on page load)
- `login(token, user)` function stores auth state
- `logout()` function clears auth state
- AuthContext wraps entire app in root layout
- Token automatically loaded from localStorage on app initialization

**Key Learnings from Story 1.6 (Login Page)** [Source: docs/stories/1.6.story.md]
- Login page already implements auth check on page load
- If `isAuthenticated` is true, redirects to `/dashboard`
- Uses `useEffect` with `isAuthenticated` and `isLoading` dependencies
- Login page needs to be updated to support `returnTo` query parameter
- Current redirect logic: `router.push('/dashboard')` (hardcoded)

**Key Learnings from Story 1.5 (Registration Page)** [Source: docs/stories/1.5.story.md]
- Registration page has similar structure to login page
- After registration, user redirected to `/login`
- Registration page also needs auth check to redirect if already logged in

**Important Coordination**:
- This story creates the foundation for all protected routes in the application
- All future dashboard routes will be protected by the `ProtectedRoute` component
- Login and register pages must be updated to support return URL functionality
- Loading states are critical to prevent "flash of unauthenticated content"

---

### Authentication Context Integration

**Auth Context API** [Source: src/contexts/AuthContext.tsx and docs/stories/1.4.story.md]
```typescript
// Import the hook
import { useAuth } from '@/contexts/AuthContext';

// Usage in ProtectedRoute component
const { isAuthenticated, isLoading, user } = useAuth();

// State values
// - isLoading: true during initial auth check (prevents flash)
// - isAuthenticated: true if user has valid token
// - user: AdminUser object or null
```

**Auth Context Behavior**:
- On app load, `isLoading` starts as `true`
- AuthContext checks localStorage for token
- If token exists, validates and sets `isAuthenticated` to `true`
- If no token or invalid, sets `isAuthenticated` to `false`
- `isLoading` becomes `false` after check completes
- This prevents flash of login redirect during initial page load

---

### Next.js Navigation Hooks

**Required Navigation Hooks** [Source: docs/architecture/tech-stack.md#Next.js]
```typescript
import { useRouter, usePathname, useSearchParams } from 'next/navigation';

// useRouter - programmatic navigation
const router = useRouter();
router.push('/login'); // Navigate to route

// usePathname - get current path
const pathname = usePathname(); // e.g., "/dashboard"

// useSearchParams - read query parameters
const searchParams = useSearchParams();
const returnTo = searchParams.get('returnTo'); // e.g., "/dashboard"
```

**Important Note**: These hooks only work in Client Components (`"use client"` directive required)

---

### File Locations and Project Structure

**New Files to Create** [Source: docs/architecture/source-tree.md]
```
src/
├── components/
│   ├── guards/
│   │   └── ProtectedRoute.tsx       # NEW: Protected route HOC
│   └── common/
│       └── LoadingSpinner.tsx       # NEW: Reusable loading spinner
├── app/
│   └── (dashboard)/
│       └── layout.tsx                # NEW: Dashboard layout with ProtectedRoute wrapper
```

**Existing Files to Modify**:
- `/src/app/(auth)/login/page.tsx` - Add returnTo query parameter handling [Source: src/app/(auth)/login/page.tsx]
- `/src/app/(auth)/register/page.tsx` - Add auth check and redirect logic [Source: src/app/(auth)/register/page.tsx]

**Route Structure** [Source: docs/architecture/source-tree.md#/src/app]
```
src/app/
├── (auth)/                          # Public routes (login, register)
│   ├── login/page.tsx
│   └── register/page.tsx
├── (dashboard)/                     # Protected routes
│   ├── layout.tsx                   # Wrap with ProtectedRoute
│   ├── incidents/...
│   ├── users/...
│   ├── categories/...
│   └── profile/...
├── layout.tsx                       # Root layout (AuthContext provider)
└── page.tsx                         # Dashboard home (protected)
```

**Route Protection Strategy**:
- **Option 1**: Wrap `(dashboard)` layout with `ProtectedRoute` → protects all child routes
- **Option 2**: Wrap individual pages → more granular but repetitive
- **Recommended**: Option 1 (use layout wrapper for all dashboard routes)

---

### ProtectedRoute Component Pattern

**Component Structure** [Source: docs/architecture/coding-standards.md#React Component Standards]
```typescript
// /src/components/guards/ProtectedRoute.tsx
'use client';

import { useEffect } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import { useAuth } from '@/contexts/AuthContext';
import LoadingSpinner from '@/components/common/LoadingSpinner';

interface ProtectedRouteProps {
  children: React.ReactNode;
}

export default function ProtectedRoute({ children }: ProtectedRouteProps) {
  const { isAuthenticated, isLoading } = useAuth();
  const router = useRouter();
  const pathname = usePathname();

  useEffect(() => {
    // Only redirect after loading completes
    if (!isLoading && !isAuthenticated) {
      // Encode current path as returnTo parameter
      const returnUrl = encodeURIComponent(pathname);
      router.push(`/login?returnTo=${returnUrl}`);
    }
  }, [isAuthenticated, isLoading, pathname, router]);

  // Show loading spinner while checking auth status
  if (isLoading) {
    return <LoadingSpinner />;
  }

  // If not authenticated, show nothing (redirect happens in useEffect)
  if (!isAuthenticated) {
    return null;
  }

  // User is authenticated, render protected content
  return <>{children}</>;
}
```

**Why useEffect for Redirect?**
- Prevents server-side rendering issues
- Allows loading state to complete before redirecting
- Avoids "cannot update a component while rendering" errors

---

### Loading Spinner Component

**LoadingSpinner Component** [Source: docs/architecture/tech-stack.md#shadcn/ui]
```typescript
// /src/components/common/LoadingSpinner.tsx
import { Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils/cn';

interface LoadingSpinnerProps {
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

export default function LoadingSpinner({
  size = 'md',
  className
}: LoadingSpinnerProps) {
  const sizeClasses = {
    sm: 'h-4 w-4',
    md: 'h-8 w-8',
    lg: 'h-12 w-12'
  };

  return (
    <div className="flex min-h-screen items-center justify-center">
      <Loader2
        className={cn(
          'animate-spin text-gray-400',
          sizeClasses[size],
          className
        )}
      />
    </div>
  );
}
```

**Lucide React Icons** [Source: docs/architecture/tech-stack.md]
- Import: `import { Loader2 } from 'lucide-react'`
- `Loader2` is a circular spinner icon
- Use Tailwind class `animate-spin` for rotation animation

---

### Return URL Query Parameter Handling

**Login Page Update** [Source: src/app/(auth)/login/page.tsx]
```typescript
// Existing login page needs to be updated
'use client';

import { useRouter, useSearchParams } from 'next/navigation';

export default function LoginPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { login } = useAuth();

  const onSubmit = async (data: LoginFormData) => {
    try {
      const response = await loginAdmin(data);
      login(response.access_token, response.user);

      // Check for returnTo parameter
      const returnTo = searchParams.get('returnTo') || '/dashboard';
      router.push(returnTo);

      toast.success(`¡Inicio de sesión exitoso! Bienvenido ${response.user.nombre}`);
    } catch (error) {
      // Error handling...
    }
  };

  // Rest of component...
}
```

**Query Parameter Encoding**:
- Use `encodeURIComponent()` when setting returnTo parameter
- Next.js `searchParams.get()` automatically decodes values
- Example URL: `/login?returnTo=%2Fdashboard%2Fincidents`

---

### Dashboard Layout Structure

**Dashboard Layout with ProtectedRoute** [Source: docs/architecture/source-tree.md#/src/app]
```typescript
// /src/app/(dashboard)/layout.tsx
'use client';

import ProtectedRoute from '@/components/guards/ProtectedRoute';

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <ProtectedRoute>
      <div className="min-h-screen bg-gray-50">
        {/* Future: Add Sidebar, Header, etc. */}
        <main className="container mx-auto py-6">
          {children}
        </main>
      </div>
    </ProtectedRoute>
  );
}
```

**Route Group Behavior** [Source: Next.js documentation]
- `(dashboard)` is a route group (parentheses indicate it doesn't affect URL)
- All routes inside `(dashboard)` inherit the layout
- Protected routes: `/dashboard`, `/incidents`, `/users`, `/categories`, `/profile`
- Layout wraps all child pages automatically

---

### TypeScript Type Safety

**Type Imports** [Source: docs/architecture/coding-standards.md#TypeScript Standards]
```typescript
// Component props interface
interface ProtectedRouteProps {
  children: React.ReactNode;
}

// Auth context types (already defined)
import type { AdminUser } from '@/lib/types/auth.types';

// React types
import type { ReactNode } from 'react';
```

---

### Coding Standards Compliance

**Naming Conventions** [Source: docs/architecture/coding-standards.md#Naming Conventions]
- Component file: `ProtectedRoute.tsx` (PascalCase)
- Directory: `guards/` (lowercase)
- Hook usage: `useAuth`, `useRouter`, `usePathname` (camelCase with `use` prefix)

**Import Order** [Source: docs/architecture/coding-standards.md#Import Order]
```typescript
// 1. React and Next.js
import { useEffect } from 'react';
import { useRouter, usePathname } from 'next/navigation';

// 2. External libraries
// (none for this component)

// 3. Internal utilities and types
import { useAuth } from '@/contexts/AuthContext';

// 4. Components
import LoadingSpinner from '@/components/common/LoadingSpinner';
```

**Client Component Directive** [Source: docs/architecture/coding-standards.md#Next.js]
- Add `"use client"` at top of file (ProtectedRoute uses hooks)
- Dashboard layout also needs `"use client"` directive

---

### Edge Cases and Considerations

**1. Avoid Flash of Unauthenticated Content (FOUC)**
- Display `LoadingSpinner` while `isLoading` is true
- Only redirect after `isLoading` becomes false
- Return `null` during redirect to prevent content flash

**2. Return URL Validation**
- Only allow internal paths (start with `/`)
- Prevent open redirect vulnerabilities
- Example validation:
  ```typescript
  const returnTo = searchParams.get('returnTo');
  const safeReturnTo = returnTo?.startsWith('/') ? returnTo : '/dashboard';
  router.push(safeReturnTo);
  ```

**3. Race Conditions**
- `useEffect` ensures redirect only happens after loading completes
- Dependencies array includes `isAuthenticated`, `isLoading`, `pathname`, `router`
- Prevents multiple redirects or premature redirects

**4. Public vs Protected Routes**
- Public routes: `/login`, `/register` (no ProtectedRoute wrapper)
- Protected routes: All routes under `(dashboard)` layout
- Auth pages redirect to `/dashboard` if user already authenticated (existing logic in Story 1.6)

---

### Testing

**Testing Strategy for This Story** [Source: docs/architecture/tech-stack.md#Testing Stack]

This story implements route protection logic that affects the entire application's security. Comprehensive testing ensures authentication checks work correctly across all scenarios.

**Test Coverage Requirements**:
- ✅ Loading state displays spinner (no content flash)
- ✅ Unauthenticated user redirects to `/login` with returnTo parameter
- ✅ Authenticated user renders protected content
- ✅ Return URL works after login
- ✅ Authenticated user cannot access `/login` or `/register`
- ✅ All protected routes require authentication

**Test Framework** [Source: docs/architecture/tech-stack.md#Testing Stack]
- **Vitest**: Unit testing framework (already configured)
- **@testing-library/react**: For rendering React components in tests
- **@testing-library/jest-dom**: For DOM matchers (already installed)

**Test File Location**:
- Co-locate test with component: `/src/components/guards/ProtectedRoute.test.tsx`

**Mock Requirements**:
```typescript
// Mock useRouter from next/navigation
const mockPush = vi.fn();
vi.mock('next/navigation', () => ({
  useRouter: () => ({
    push: mockPush,
  }),
  usePathname: () => '/dashboard',
}));

// Mock AuthContext
vi.mock('@/contexts/AuthContext', () => ({
  useAuth: vi.fn(() => ({
    isAuthenticated: false,
    isLoading: false,
  })),
}));
```

**Manual Testing Scenarios**:
1. **Unauthenticated Access**:
   - Logout if logged in
   - Navigate to `/dashboard`
   - Verify redirect to `/login?returnTo=/dashboard`
   - Verify loading spinner displays briefly (no content flash)

2. **Return URL Flow**:
   - From `/login?returnTo=/dashboard`, login successfully
   - Verify redirect back to `/dashboard` (not just `/dashboard` by default)
   - Test with different returnTo URLs (`/incidents`, `/users`, etc.)

3. **Authenticated User on Auth Pages**:
   - Login successfully
   - Navigate to `/login` → should redirect to `/dashboard` immediately
   - Navigate to `/register` → should redirect to `/dashboard` immediately

4. **Public Routes Remain Accessible**:
   - Logout
   - Verify `/login` and `/register` pages load without redirect
   - Verify no loading spinner on public pages

5. **All Protected Routes**:
   - Test each protected route while not authenticated:
     - `/dashboard`, `/incidents`, `/users`, `/categories`, `/profile`
   - Verify all redirect to `/login?returnTo=<current-path>`

---

## Change Log

| Date       | Version | Description                      | Author        |
|------------|---------|----------------------------------|---------------|
| 2025-10-05 | 1.0     | Initial story draft created      | Bob (SM)      |

---

## Dev Agent Record

### Agent Model Used

_To be populated by development agent._

### Debug Log References

_To be populated by development agent._

### Completion Notes

_To be populated by development agent._

### File List

_To be populated by development agent._

---

## QA Results

_This section will be populated by the QA agent after story completion._
