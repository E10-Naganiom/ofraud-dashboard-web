# Story 2.3: Incident Category Filter

<!-- Powered by BMAD™ Core -->

## Status
Done

---

## Story

**As an** administrator,
**I want** to filter incidents by cybercrime category,
**so that** I can focus on specific types of incidents (e.g., phishing, fraud, etc.).

---

## Acceptance Criteria

1.  Category filter dropdown added to incident list page (near search bar).
2.  Dropdown populated with all categories fetched from `GET /categories`.
3.  Dropdown options display category title.
4.  Default option: "Todas las categorías" (shows all incidents).
5.  When a category is selected, the incident list is filtered to show only incidents with a matching `id_categoria`.
6.  Filtering can be client-side OR via API parameter (e.g., `?id_categoria=[id]`).
7.  The filter works in conjunction with search (both filters are applied simultaneously).
8.  The selected filter persists in the UI state (the dropdown shows the selected category).
9.  Clearing the filter (selecting "Todas las categorías") shows all incidents again.
10. If no incidents match the selected category, a message is displayed: "No se encontraron incidentes en esta categoría".

---

## Dev Notes

### Previous Story Insights

- **Search Implemented**: Story 2.2 added a debounced search input to the incidents page. The filtering logic resides in `incidents/page.tsx` and should be combined with the new category filter.
- **Component Structure**: The search bar is currently implemented directly in the page. This story will refactor it into a dedicated `IncidentFilters.tsx` component.

### Architecture & Implementation Plan

**1. Data Fetching & State Management**
- **`Category` Type**: A new type definition will be created. [Source: `docs/architecture/source-tree.md`]
  - **File**: `src/lib/types/category.types.ts`
  - **Interface**: `export interface Category { id: number; nombre: string; }`
- **API Client**: A new function to fetch categories will be added. [Source: `docs/architecture/source-tree.md`]
  - **File**: `src/lib/api/categories.ts`
  - **Function**: `export async function getCategories(): Promise<Category[]> { ... }` to call `GET /categories`.
- **Custom Hook**: A `useCategories` hook will manage the state for categories. [Source: `docs/architecture/coding-standards.md`]
  - **File**: `src/hooks/useCategories.ts`
  - **Functionality**: Handles fetching, loading, and error states for categories.

**2. UI Components**
- **`IncidentFilters.tsx` Component**: A new component will be created to encapsulate all filtering controls. [Source: `docs/architecture/source-tree.md`]
  - **File**: `src/components/incidents/IncidentFilters.tsx`
  - **Contents**: It will contain the existing search input and the new category filter dropdown (`Select` from shadcn/ui).
  - **Props**: It will accept filter state and change handlers from the parent page (`searchTerm`, `onSearchTermChange`, `selectedCategory`, `onCategoryChange`).

**3. Page Integration**
- **`incidents/page.tsx` Refactor**: The main incidents page will be updated.
  - It will use the new `IncidentFilters` component.
  - It will manage the state for `selectedCategory`.
  - The `filteredIncidents` `useMemo` hook will be updated to apply both the search term and the selected category filters.

---

## Dev Agent Record

### File List
- `src/lib/types/category.types.ts`
- `src/lib/api/categories.ts`
- `src/hooks/useCategories.ts`

---

## Tasks / Subtasks

- [x] **Task 1: Define Category Type** (AC: 2)
    - [x] Create file `src/lib/types/category.types.ts`.
    - [x] Define and export the `Category` interface: `{ id: number; nombre: string; descripcion?: string; }`.
- [x] **Task 2: Create API Client for Categories** (AC: 2)
    - [x] Create file `src/lib/api/categories.ts`.
    - [x] Implement `getCategories` async function to fetch data from `GET /categories`.
    - [x] Include error handling.
- [x] **Task 3: Create `useCategories` Hook** (AC: 2)
    - [x] Create file `src/hooks/useCategories.ts`.
    - [x] Implement the `useCategories` custom hook to fetch categories and manage loading/error states.
- [x] **Task 4: Create `IncidentFilters` Component** (AC: 1, 3, 4)
    - [x] Create file `src/components/incidents/IncidentFilters.tsx`.
    - [x] Move the search input logic from `incidents/page.tsx` into this component.
    - [x] Add a `Select` component (from shadcn/ui) for category filtering.
    - [x] Populate the `Select` with data from the `useCategories` hook.
    - [x] Ensure the default option "Todas las categorías" is present.
- [x] **Task 5: Update Incidents Page** (AC: 5, 6, 7, 8, 9, 10)
    - [x] Open `src/app/(dashboard)/dashboard/incidents/page.tsx`.
    - [x] Add state for `selectedCategory`, defaulting to `'all'`.
    - [x] Replace the existing search bar `div` with the new `<IncidentFilters />` component, passing the required state and handlers.
    - [x] Update the `useMemo` hook for `filteredIncidents` to chain the category filter and the text search filter.
    - [x] Update the empty state logic to show the correct message when no incidents match the combined filters.
- [x] **Task 6: Verification**
    - [x] Run `npm run dev` and navigate to the incidents page.
    - [x] Verify that the category dropdown populates correctly.
    - [x] Test filtering by category.
    - [x] Test filtering by search term.
    - [x] Test combined filtering (category and search).
    - [x] Verify the "clear filter" functionality works for both filters.
    - [x] Check all empty state messages.
    - [x] Run `npm run lint` and `npm run build` to check for errors.

---
