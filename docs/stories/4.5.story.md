# Story 4.5: Delete Category (RF04 - Delete from Detail View)

## Status
Done

## Story

**As a** administrator,
**I want** to delete cybercrime categories that are no longer relevant,
**so that** the taxonomy remains focused and up-to-date.

## Acceptance Criteria

1. "Eliminar" button on category detail page triggers delete action
2. Confirmation dialog displayed: "¿Está seguro de que desea eliminar esta categoría? Esta acción no se puede deshacer."
3. If category has associated incidents (check via `GET /categories/[id]/statistics` or backend validation):
   - Display error: "No se puede eliminar la categoría. Tiene incidentes asociados."
   - Do not proceed with deletion
4. If no associated incidents, on confirmation call API: `DELETE /categories/[id]`
5. API success response (200):
   - Toast: "Categoría eliminada exitosamente"
   - Navigate back to category list
6. API error responses:
   - 404 Not Found: "Categoría no encontrada"
   - 400 Bad Request (has incidents): "No se puede eliminar la categoría (tiene incidentes asociados)"
7. Loading state during API call (dialog remains open with spinner)
8. "Cancelar" in dialog closes dialog without deleting

## Tasks / Subtasks

- [x] Add "Eliminar" button to category detail page (AC: 1)
  - [x] Update `/src/app/(dashboard)/categories/[id]/page.tsx` to include delete button
  - [x] Button should trigger delete confirmation dialog
- [x] Create confirmation dialog component (AC: 2, 8)
  - [x] Use shadcn/ui AlertDialog component
  - [x] Dialog title: "Confirmar eliminación"
  - [x] Dialog message: "¿Está seguro de que desea eliminar esta categoría? Esta acción no se puede deshacer."
  - [x] Buttons: "Cancelar" (close dialog), "Eliminar" (proceed with deletion)
- [x] Check for associated incidents (AC: 3)
  - [x] Option 1: Call `GET /categories/[id]/statistics` to check incident count before deletion
  - [x] Option 2: Rely on backend validation (attempt delete, handle 400 error)
  - [x] If incidents exist, display error: "No se puede eliminar la categoría. Tiene incidentes asociados."
  - [x] Do not call DELETE endpoint
- [x] Implement delete API call (AC: 4)
  - [x] Add `deleteCategory(id: string)` function to `src/lib/api/categories.ts`
  - [x] Call `DELETE /categories/[id]` endpoint
  - [x] Only call if no associated incidents (or rely on backend validation)
- [x] Handle API success response (AC: 5)
  - [x] Show toast: "Categoría eliminada exitosamente"
  - [x] Navigate back to `/dashboard/categories` using `useRouter`
  - [x] Close confirmation dialog
- [x] Handle API error responses (AC: 6)
  - [x] 404 Not Found: "Categoría no encontrada"
  - [x] 400 Bad Request (has incidents): "No se puede eliminar la categoría (tiene incidentes asociados)"
  - [x] Display error message in dialog or as toast
  - [x] Keep dialog open to allow user to cancel
- [x] Add loading state (AC: 7)
  - [x] Show loading spinner on "Eliminar" button in dialog
  - [x] Disable dialog buttons while deleting
  - [x] Keep dialog open until API response received
- [x] Implement cancel action (AC: 8)
  - [x] "Cancelar" button closes dialog without API call
  - [x] No changes to category data

## Dev Notes

### Tech Stack
[Source: architecture/tech-stack.md]
- **Framework**: Next.js 15.5.4 with App Router
- **Language**: TypeScript 5.9.3 (strict mode)
- **Styling**: Tailwind CSS 4.1.14
- **UI Components**: shadcn/ui (AlertDialog, Button, Toast)
- **State Management**: React hooks (useState for dialog state)

### Source Tree / File Locations
[Source: architecture/source-tree.md]
- **Page**: `/src/app/(dashboard)/categories/[id]/page.tsx` (add delete button)
- **API Client**: `/src/lib/api/categories.ts` (add `deleteCategory()` function)
- **Types**: `/src/lib/types/category.types.ts`
- **Dialog Component**: Use shadcn/ui AlertDialog (imported from `@/components/ui/alert-dialog`)

### Data Models
[Source: PRD Epic 4]
No specific data model for deletion. Only `id` is required.

**Optional Statistics Model** (if checking incidents before deletion):
```typescript
interface CategoryStatistics {
  incidentCount: number;
}
```

### API Specifications
[Source: PRD Epic 4, architecture/tech-stack.md]

**Delete Category Endpoint**:
- **Endpoint**: `DELETE /categories/[id]`
- **Base URL**: `NEXT_PUBLIC_API_BASE_URL`
- **Authentication**: JWT token required
- **Success Response (200)**: `{ message: "Categoría eliminada exitosamente" }`
- **Error Responses**:
  - 404 Not Found: Category does not exist
  - 400 Bad Request: Category has associated incidents (cannot delete)
  - 401 Unauthorized: Invalid/missing token

**Optional Statistics Endpoint** (to check incidents):
- **Endpoint**: `GET /categories/[id]/statistics`
- **Success Response (200)**: `{ incidentCount: number }`
- **Note**: This endpoint may not exist; if not, rely on backend validation during DELETE

### Component Specifications
[Source: architecture/source-tree.md, architecture/coding-standards.md]

**AlertDialog Usage** (shadcn/ui):
- Import from `@/components/ui/alert-dialog`
- Structure:
  ```tsx
  <AlertDialog open={isOpen} onOpenChange={setIsOpen}>
    <AlertDialogContent>
      <AlertDialogHeader>
        <AlertDialogTitle>Confirmar eliminación</AlertDialogTitle>
        <AlertDialogDescription>
          ¿Está seguro de que desea eliminar esta categoría? Esta acción no se puede deshacer.
        </AlertDialogDescription>
      </AlertDialogHeader>
      <AlertDialogFooter>
        <AlertDialogCancel>Cancelar</AlertDialogCancel>
        <AlertDialogAction onClick={handleDelete} disabled={isDeleting}>
          {isDeleting ? 'Eliminando...' : 'Eliminar'}
        </AlertDialogAction>
      </AlertDialogFooter>
    </AlertDialogContent>
  </AlertDialog>
  ```

**Delete Button on Detail Page**:
- Style: Destructive/danger variant (red background)
- Text: "Eliminar"
- Icon: Trash icon (optional)
- Position: Next to "Editar" button in action bar

### Coding Standards
[Source: architecture/coding-standards.md]
- TypeScript strict mode
- Use useState to manage dialog open/close state
- Use async/await for API calls with try-catch
- Explicit error handling for each error response code
- Display user-friendly error messages in Spanish
- Use `useRouter()` for navigation after successful deletion

### Delete Flow Options
1. **Option A (Check First)**: Call statistics endpoint before attempting delete
   - Pro: Better UX, immediate feedback
   - Con: Extra API call, requires statistics endpoint to exist
2. **Option B (Backend Validation)**: Attempt delete, handle 400 error
   - Pro: Fewer API calls
   - Con: Slower feedback, user sees confirmation dialog before knowing if delete is possible

**Recommendation**: Use Option B (backend validation) for simplicity unless statistics endpoint already exists.

### Testing
[Source: architecture/coding-standards.md]
- **Test Location**: `page.test.tsx` (category detail page)
- **Framework**: Vitest (Post-MVP)
- **Test Cases**:
  - Delete button opens confirmation dialog
  - Cancel button closes dialog without deleting
  - Confirm button calls DELETE API
  - Success: toast shown, navigates to category list
  - Error: 400 (has incidents) displays error message
  - Error: 404 displays "Categoría no encontrada"

### Project Structure Notes
- Ensure delete functionality is consistent with other delete operations in the app (users, incidents)
- Consider creating a reusable `useDeleteConfirmation` hook for delete dialogs if used in multiple places
- No specific guidance found in architecture docs for statistics endpoint (assume it may not exist)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None

### Completion Notes List
- Implemented Option B (backend validation) - relies on API 400 error for incident check
- Used shadcn/ui AlertDialog for confirmation with proper destructive styling
- Delete button styled with destructive variant for visual warning
- Proper loading state management - dialog remains open during deletion
- Toast notifications for both success and error scenarios
- Navigation to categories list after successful deletion
- All TypeScript strict mode requirements met

### File List
- src/app/(dashboard)/categories/[id]/page.tsx (modified - added delete dialog and functionality)
- src/lib/api/categories.ts (modified - added deleteCategory function)

## QA Results
_To be filled by QA agent_
