# Story 1.3: API Client Layer and Error Handling

<!-- Powered by BMAD™ Core -->

## Status
Done

---

## Story

**As a** developer,
**I want** a centralized API client with JWT token management and error handling,
**so that** all backend communication is consistent, secure, and provides clear error feedback.

---

## Acceptance Criteria

1. API client module created (`/src/lib/api.ts`) with base configuration
2. Axios or fetch wrapper configured with `NEXT_PUBLIC_API_BASE_URL` from environment variables
3. Request interceptor adds JWT token from localStorage/cookies to Authorization header
4. Response interceptor handles common errors:
   - 401 Unauthorized → clear auth state and redirect to login
   - 500 Internal Server Error → return user-friendly error message
   - Network errors → return "Verifique su conexión a Internet" message
5. API client exports typed functions for auth endpoints: `registerAdmin()`, `loginAdmin()`
6. TypeScript interfaces defined for API request/response shapes (`/src/lib/types.ts`)
7. Error response structure matches backend API format (NestJS standard error response)
8. Unit tests written for error interceptor logic (401 redirect, error message transformation)

---

## Tasks / Subtasks

- [x] **Task 1: Create API Client Configuration** (AC: 1, 2)
  - [x] Create file `/src/lib/api/client.ts`
  - [x] Install Axios: `npm install axios`
  - [x] Configure Axios instance with base URL from `NEXT_PUBLIC_API_BASE_URL`
  - [x] Set default headers (Content-Type: application/json)
  - [x] Export configured API client instance

- [x] **Task 2: Implement Request Interceptor** (AC: 3)
  - [x] Add request interceptor to attach JWT token to Authorization header
  - [x] Read token from localStorage (key: 'auth_token' or as defined in AuthContext)
  - [x] If token exists, add header: `Authorization: Bearer ${token}`
  - [x] If no token, continue request without Authorization header (for public endpoints like login/register)

- [x] **Task 3: Implement Response Interceptor** (AC: 4, 7)
  - [x] Add response interceptor for successful responses (2xx)
  - [x] Add error interceptor for failed responses
  - [x] Handle 401 Unauthorized:
    - Clear token from localStorage
    - Clear auth state (if possible from interceptor context)
    - Redirect to `/login` with `returnTo` query parameter
  - [x] Handle 500 Internal Server Error:
    - Return user-friendly message: "Error interno del servidor. Por favor, intente nuevamente."
  - [x] Handle network errors (no response from server):
    - Return message: "Verifique su conexión a Internet"
  - [x] Handle 404 Not Found, 409 Conflict, 400 Bad Request:
    - Pass through error response message from backend
  - [x] Ensure error structure matches NestJS standard: `{ statusCode, message, error }`

- [x] **Task 4: Define TypeScript Types for API Responses** (AC: 6)
  - [x] Create file `/src/lib/types/api.types.ts`
  - [x] Define `ApiErrorResponse` interface:
    - `statusCode: number`
    - `message: string | string[]`
    - `error: string`
  - [x] Define `ApiSuccessResponse<T>` generic interface for typed success responses
  - [x] Export types for use in API functions

- [x] **Task 5: Create Auth API Functions** (AC: 5, 6)
  - [x] Create file `/src/lib/api/auth.ts`
  - [x] Define `RegisterAdminRequest` interface:
    - `nombre: string`
    - `correo: string`
    - `contrasena: string`
  - [x] Define `RegisterAdminResponse` interface:
    - `id: string`
    - `nombre: string`
    - `correo: string`
    - `is_admin: boolean`
  - [x] Define `LoginAdminRequest` interface:
    - `correo: string`
    - `contrasena: string`
  - [x] Define `LoginAdminResponse` interface:
    - `access_token: string`
    - `user: { id: string; nombre: string; correo: string; is_admin: boolean }`
  - [x] Implement `registerAdmin(data: RegisterAdminRequest): Promise<RegisterAdminResponse>`
    - POST request to `/auth/register`
  - [x] Implement `loginAdmin(data: LoginAdminRequest): Promise<LoginAdminResponse>`
    - POST request to `/auth/login`
  - [x] Export both functions

- [x] **Task 6: Update Environment Variables** (AC: 2)
  - [x] Add `NEXT_PUBLIC_API_BASE_URL` to `.env.example`
  - [x] Document example value: `http://localhost:3000/api` (or actual backend URL)
  - [x] Create `.env.local` if not exists and add actual API base URL for development

- [x] **Task 7: Write Unit Tests for API Client** (AC: 8)
  - [x] Install Vitest and testing utilities (if not already installed)
  - [x] Create test file `/src/lib/api/client.test.ts`
  - [x] Test: Request interceptor adds Authorization header when token exists
  - [x] Test: Request interceptor skips header when no token
  - [x] Test: 401 response clears token and redirects to /login
  - [x] Test: 500 response returns Spanish error message
  - [x] Test: Network error returns connection message
  - [x] Test: Error response structure matches NestJS format
  - [x] Run tests: `npm run test`

- [x] **Task 8: Verification and Testing** (AC: All)
  - [x] Verify API client can be imported: `import { api } from '@/lib/api/client'`
  - [x] Verify auth functions can be imported: `import { registerAdmin, loginAdmin } from '@/lib/api/auth'`
  - [x] Test manually with mock backend or actual backend (if available)
  - [x] Run `npm run lint` to ensure no ESLint errors
  - [x] Run `npm run build` to verify production build succeeds
  - [x] Verify TypeScript types are properly inferred in component usage

---

## Dev Notes

### Previous Story Insights

**Key Learnings from Story 1.2** [Source: docs/stories/1.2.story.md#Dev Agent Record]
- Project is at root level (no `/frontend` subdirectory despite PRD assumption)
- Next.js 15.5.4 is installed
- Tailwind CSS v4 is in use
- All paths use `@/` alias for `/src/*`
- shadcn/ui components are installed in `/src/components/ui/`

**Important Note**: The PRD mentions a monorepo structure with `/frontend` and `/backend` directories, but Story 1.1 created the project at root level. All file paths in this story reflect the actual structure (`/src/*` instead of `/frontend/src/*`).

---

### API Client Architecture

**HTTP Client Choice: Axios** [Source: docs/prd/technical-assumptions.md#Data Fetching]
- Use Axios for HTTP requests (recommended over native fetch)
- Axios provides:
  - Automatic JSON transformation
  - Request/response interceptors (critical for JWT injection and error handling)
  - Better error handling than fetch
  - Request cancellation support
- Install: `npm install axios`
- Install types: `npm install --save-dev @types/axios` (if needed)

**API Base URL Configuration** [Source: docs/prd/technical-assumptions.md#Environment Configuration]
- Environment variable: `NEXT_PUBLIC_API_BASE_URL`
- Development: `http://localhost:3000/api` (or actual backend URL)
- Production: `https://api.ofraud.com` (placeholder - actual URL TBD)
- **Why NEXT_PUBLIC_ prefix**: Makes variable accessible in browser-side code (Next.js requirement)

**Backend API Details** [Source: docs/brief.md#Proposed Solution]
- Framework: NestJS (Node.js framework)
- Database: MySQL
- Authentication: JWT tokens
- Documentation: Swagger/OpenAPI
- CORS: Configured for frontend domain
- No backend code changes required for MVP

---

### File Locations and Project Structure

**API Client Files** [Source: docs/architecture/source-tree.md#/src/lib]
```
src/lib/
├── api/
│   ├── client.ts          # NEW: Axios instance configuration
│   ├── auth.ts            # NEW: Authentication API functions
│   └── interceptors.ts    # OPTIONAL: Extract interceptors if file grows large
└── types/
    ├── api.types.ts       # NEW: Common API response types
    └── auth.types.ts      # NEW: Auth-specific types (request/response interfaces)
```

**Why Separate Files**:
- `client.ts`: Core Axios configuration and interceptors
- `auth.ts`: Auth-specific API functions (registerAdmin, loginAdmin)
- Future: Add `incidents.ts`, `users.ts`, `categories.ts` for domain-specific endpoints
- `types/`: TypeScript interfaces for type safety

**Path Alias** [Source: docs/architecture/source-tree.md#Path Aliases]
- Use `@/` for absolute imports: `import { api } from '@/lib/api/client'`
- Configured in `tsconfig.json`: `"@/*": ["./src/*"]`

---

### JWT Token Management

**Token Storage** [Source: docs/prd/technical-assumptions.md#Data Fetching]
- **Primary**: localStorage (key: `auth_token` or similar)
- **Alternative**: httpOnly cookies (more secure, but requires backend cooperation)
- For MVP: Use localStorage for simplicity
- Token format: JWT (JSON Web Token)
- Header format: `Authorization: Bearer <token>`

**Token Lifecycle**:
1. **Login**: Backend returns `access_token` in login response
2. **Store**: Frontend stores token in localStorage
3. **Inject**: Request interceptor adds token to all API requests
4. **Validate**: Backend validates token on protected endpoints
5. **Expire**: If 401 response, token is expired/invalid → clear and redirect to login

**Security Considerations** [Source: docs/architecture/coding-standards.md#Security Best Practices]
- localStorage is vulnerable to XSS attacks, but acceptable for MVP
- Future: Consider httpOnly cookies for production
- Never log tokens to console in production
- Clear token immediately on logout or 401 error

---

### Error Handling Strategy

**Backend Error Response Format (NestJS Standard)** [Source: Epic 1 Story 1.3 AC#7]
```typescript
{
  statusCode: 401,
  message: "Unauthorized",
  error: "Unauthorized"
}
```
Or for validation errors:
```typescript
{
  statusCode: 400,
  message: ["Email must be valid", "Password is too short"],
  error: "Bad Request"
}
```

**Frontend Error Handling Matrix**:

| HTTP Status | Backend Response | Frontend Action |
|-------------|------------------|-----------------|
| 401 Unauthorized | `{ statusCode: 401, message: "..." }` | Clear token, redirect to `/login?returnTo=<currentPath>` |
| 404 Not Found | `{ statusCode: 404, message: "User not found" }` | Display backend message in Spanish |
| 409 Conflict | `{ statusCode: 409, message: "Email already exists" }` | Display backend message in Spanish |
| 400 Bad Request | `{ statusCode: 400, message: [...] }` | Display validation errors in Spanish |
| 500 Server Error | `{ statusCode: 500, message: "..." }` | Display: "Error interno del servidor. Por favor, intente nuevamente." |
| Network Error | (No response) | Display: "Verifique su conexión a Internet" |

**Spanish Error Messages** [Source: docs/prd/technical-assumptions.md#Internationalization]
- All user-facing strings must be in Spanish
- Backend may return English messages - frontend should translate if possible
- Use constants file for Spanish error messages: `/src/lib/constants/messages.ts`

**Error Interceptor Implementation Pattern**:
```typescript
api.interceptors.response.use(
  (response) => response, // Pass through successful responses
  (error) => {
    if (error.response) {
      // Server responded with error status
      const { status, data } = error.response;
      if (status === 401) {
        // Clear auth and redirect
        localStorage.removeItem('auth_token');
        window.location.href = '/login';
      } else if (status === 500) {
        error.message = 'Error interno del servidor. Por favor, intente nuevamente.';
      }
    } else if (error.request) {
      // Request made but no response (network error)
      error.message = 'Verifique su conexión a Internet';
    }
    return Promise.reject(error);
  }
);
```

---

### TypeScript Type Definitions

**API Response Types** [Source: docs/architecture/coding-standards.md#TypeScript Standards]

**Generic Error Response**:
```typescript
// src/lib/types/api.types.ts
export interface ApiErrorResponse {
  statusCode: number;
  message: string | string[]; // Can be single string or array of validation errors
  error: string; // Error type (e.g., "Bad Request", "Unauthorized")
}

export interface ApiSuccessResponse<T = unknown> {
  data: T;
  statusCode?: number;
}
```

**Auth-Specific Types**:
```typescript
// src/lib/types/auth.types.ts
export interface RegisterAdminRequest {
  nombre: string;
  correo: string;
  contrasena: string;
}

export interface RegisterAdminResponse {
  id: string;
  nombre: string;
  correo: string;
  is_admin: boolean;
}

export interface LoginAdminRequest {
  correo: string;
  contrasena: string;
}

export interface LoginAdminResponse {
  access_token: string;
  user: {
    id: string;
    nombre: string;
    correo: string;
    is_admin: boolean;
  };
}
```

**Why Separate Type Files**:
- `api.types.ts`: Common/shared API types used across all domains
- `auth.types.ts`: Auth-specific request/response types
- Future: `incident.types.ts`, `user.types.ts`, `category.types.ts`
- Improves discoverability and avoids circular dependencies

---

### Coding Standards Compliance

**Function Return Types** [Source: docs/architecture/coding-standards.md#TypeScript Standards]
- All API functions MUST have explicit return types
- Use `Promise<T>` for async functions
- Example: `async function loginAdmin(data: LoginAdminRequest): Promise<LoginAdminResponse>`

**Error Handling** [Source: docs/architecture/coding-standards.md#Error Handling]
- Use try-catch blocks in API functions
- Re-throw errors after logging (let caller handle)
- Avoid swallowing errors silently

**Import Order** [Source: docs/architecture/coding-standards.md#Import Order]
```typescript
// 1. External libraries
import axios, { AxiosInstance } from 'axios';

// 2. Internal types
import type { ApiErrorResponse } from '@/lib/types/api.types';

// 3. Internal utilities (if any)
```

**Naming Conventions** [Source: docs/architecture/coding-standards.md#Naming Conventions]
- Files: `camelCase.ts` (e.g., `client.ts`, `auth.ts`)
- Functions: `camelCase` (e.g., `registerAdmin`, `loginAdmin`)
- Interfaces: `PascalCase` (e.g., `LoginAdminRequest`)
- Constants: `UPPER_SNAKE_CASE` (e.g., `API_BASE_URL`)

---

### Testing Requirements

**Unit Test Strategy** [Source: docs/prd/technical-assumptions.md#Testing Requirements]
- Focus on **high-risk areas**: API client error handling, interceptors
- Use **Vitest** (not Jest) for better ESM support
- Target: 30-40% code coverage (selective, not exhaustive)
- Test files: Co-locate with source (e.g., `client.test.ts` next to `client.ts`)

**Critical Test Cases for This Story** (AC: 8):
1. **Request interceptor adds token**: Mock localStorage, verify Authorization header
2. **Request interceptor skips token if not logged in**: Verify header is not added
3. **401 response clears token**: Mock 401 response, verify localStorage cleared
4. **401 response redirects to login**: Verify `window.location.href` changed
5. **500 response returns Spanish message**: Verify error message transformed
6. **Network error returns Spanish message**: Verify offline error handling
7. **Error structure matches NestJS format**: Verify error shape

**Testing Tools**:
- **Vitest**: Unit testing framework
- **@testing-library/react** (if testing components): Not needed for this story
- **axios-mock-adapter** or **msw** (Mock Service Worker): For mocking Axios requests

**Test File Location**:
```
src/lib/api/
├── client.ts
├── client.test.ts       # NEW: Unit tests for Axios client
├── auth.ts
└── auth.test.ts         # NEW: Unit tests for auth functions
```

**Running Tests**:
- Command: `npm run test` or `npx vitest`
- Watch mode: `npx vitest --watch`
- Coverage: `npx vitest --coverage`

---

### Dependencies to Install

**Production Dependencies**:
- `axios` - HTTP client library

**Development Dependencies** (for testing):
- `vitest` - Unit testing framework (if not already installed)
- `@vitest/ui` - Vitest UI for test visualization (optional)
- `axios-mock-adapter` or `msw` - For mocking HTTP requests in tests

**Installation Commands**:
```bash
npm install axios
npm install --save-dev vitest @vitest/ui axios-mock-adapter
```

---

### Project Structure Alignment

**No Conflicts Detected**:
- `/src/lib/api/` directory does not yet exist (will be created in this story)
- `/src/lib/types/` directory does not yet exist (will be created in this story)
- All paths align with Story 1.1 structure
- `.env.example` exists (created in Story 1.1) - will be updated with `NEXT_PUBLIC_API_BASE_URL`

**New Directories Created**:
- `/src/lib/api/`
- `/src/lib/types/`

**New Files Created**:
- `/src/lib/api/client.ts`
- `/src/lib/api/auth.ts`
- `/src/lib/types/api.types.ts`
- `/src/lib/types/auth.types.ts`
- `/src/lib/api/client.test.ts` (test file)
- `/src/lib/api/auth.test.ts` (test file)

---

## Testing

### Testing Strategy for This Story

**Unit Testing (Primary)** [Source: docs/prd/technical-assumptions.md#Testing Requirements]

This story is one of the **high-risk areas** that requires unit tests according to the MVP testing strategy. The API client handles authentication, error handling, and all backend communication - critical functionality that warrants automated testing.

**Test Coverage Requirements**:
- ✅ Request interceptor (token injection)
- ✅ Response interceptor (error handling)
- ✅ 401 redirect logic
- ✅ Error message transformation
- ✅ Network error handling
- ✅ Auth API functions (registerAdmin, loginAdmin)

**Manual Testing**:
1. **API Client Import Test**:
   - Import client in a test component
   - Verify no TypeScript errors
   - Verify Axios instance is configured correctly

2. **Token Injection Test**:
   - Set token in localStorage
   - Make API call (even to non-existent endpoint)
   - Inspect network request in browser DevTools
   - Verify Authorization header is present

3. **Error Handling Test**:
   - Simulate 401 by calling protected endpoint without token
   - Verify redirect to `/login` occurs
   - Verify token is cleared from localStorage

4. **Network Error Test**:
   - Disconnect from internet
   - Attempt API call
   - Verify Spanish error message is displayed

**Test Framework Configuration** [Source: docs/prd/technical-assumptions.md#Testing Tools]

If Vitest is not yet configured:
1. Create `vitest.config.ts` in project root
2. Configure path aliases to match `tsconfig.json`
3. Add test script to `package.json`: `"test": "vitest"`

**Test File Locations** [Source: docs/architecture/source-tree.md#Testing Directory Structure]
- Co-locate tests with source files (recommended)
- Naming: `*.test.ts` or `*.spec.ts`
- Example: `client.test.ts` next to `client.ts`

**Integration Testing** (Not required for this story):
- API integration tests will come in later stories when testing actual login/register flows
- This story focuses on the client layer infrastructure

**E2E Testing** (Post-MVP):
- Playwright tests for full authentication flow will come in Epic 1 Story 1.6 or later

---

## Change Log

| Date       | Version | Description                      | Author        |
|------------|---------|----------------------------------|---------------|
| 2025-10-04 | 1.0     | Initial story draft created      | Bob (SM)      |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None - Implementation completed without major blockers.

### Completion Notes

Successfully implemented the API client layer with comprehensive error handling and JWT token management. All acceptance criteria met:

1. ✅ API client created with Axios configuration
2. ✅ Request interceptor adds JWT tokens automatically
3. ✅ Response interceptor handles 401, 500, and network errors with Spanish messages
4. ✅ TypeScript interfaces defined for all API request/response types
5. ✅ Auth functions (registerAdmin, loginAdmin) implemented and exported
6. ✅ Environment variables configured (NEXT_PUBLIC_API_BASE_URL)
7. ✅ Comprehensive unit tests written (20 tests, 100% passing)
8. ✅ All linting and build checks pass

**Key Implementation Details:**
- Token storage uses localStorage with key 'auth_token'
- 401 errors automatically clear tokens and redirect to /login with returnTo parameter
- Error messages are in Spanish per project requirements
- ESLint configured to allow `any` type in test files only
- Vitest configured with jsdom environment and path aliases

**Test Results:**
- 20/20 tests passing
- Coverage includes request/response interceptors, error handling, and auth functions
- No ESLint errors
- Production build successful

### File List

**New Files Created:**
- `/src/lib/api/client.ts` - Axios instance with interceptors
- `/src/lib/api/auth.ts` - Authentication API functions
- `/src/lib/types/api.types.ts` - Common API response types
- `/src/lib/types/auth.types.ts` - Auth-specific types
- `/src/lib/constants/messages.ts` - Spanish error messages
- `/src/lib/api/client.test.ts` - Unit tests for API client
- `/src/lib/api/auth.test.ts` - Unit tests for auth functions
- `/vitest.config.ts` - Vitest test configuration

**Modified Files:**
- `/.env.example` - Already had NEXT_PUBLIC_API_BASE_URL configured
- `/.env.local` - Already had NEXT_PUBLIC_API_BASE_URL configured
- `/package.json` - Added test scripts and testing dependencies
- `/.eslintrc.json` - Added override to allow `any` in test files

---

## QA Results

_This section will be populated by the QA agent after story completion._
