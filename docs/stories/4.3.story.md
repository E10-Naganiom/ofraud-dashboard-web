# Story 4.3: Create New Category (RF03)

## Status
Done

## Story

**As a** administrator,
**I want** to create new cybercrime categories with all relevant information,
**so that** users have accurate classifications when reporting incidents.

## Acceptance Criteria

1. "Crear Categoría" button on category list page navigates to `/dashboard/categories/new`
2. Create category form displays fields:
   - Título (text, required, unique, max 255 chars)
   - Descripción (textarea, required, max 500 chars)
   - Nivel de riesgo (dropdown: 1=Muy Bajo, 2=Bajo, 3=Medio, 4=Alto, required)
   - Señales (textarea, optional, max 500 chars)
   - Prevención (textarea, required, max 500 chars)
   - Acciones (textarea, optional, max 500 chars)
   - Ejemplos (textarea, optional, max 500 chars)
   - Imagen (file upload, optional, accept image formats: jpg, png, webp)
3. Form validation using React Hook Form + Zod:
   - Required fields validated
   - Title uniqueness validated (backend enforcement)
   - Character limits enforced
4. Image upload:
   - On file select, upload to backend via `POST /files/upload`
   - Store returned image URL in form state
   - Display image preview
5. Submit button disabled until form valid
6. On submit, call API: `POST /categories` with category data (including image URL if uploaded)
7. API success response (201):
   - Toast: "¡Categoría registrada exitosamente!"
   - Navigate to category detail page or back to category list
8. API error responses:
   - 409 Conflict (title exists): "La categoría ya está registrada"
   - 400 Bad Request: Display specific validation errors
9. Loading state during API call
10. "Cancelar" button navigates back without saving

## Tasks / Subtasks

- [x] Create new category page at `/src/app/(dashboard)/categories/new/page.tsx` (AC: 1)
  - [x] Create `new` directory under categories
  - [x] Create page.tsx file
- [x] Create category form component (AC: 2)
  - [x] Create `src/components/categories/CategoryForm.tsx`
  - [x] Add all required and optional form fields
  - [x] Use shadcn/ui form components (Input, Textarea, Select)
  - [x] Add field labels and helper text
- [x] Implement form validation with React Hook Form + Zod (AC: 3)
  - [x] Install react-hook-form and zod (if not already installed)
  - [x] Create validation schema in `src/lib/validations/category.schema.ts`
  - [x] Define required fields, max character limits
  - [x] Integrate schema with React Hook Form's `useForm` hook
  - [x] Display validation errors inline for each field
- [x] Implement image upload functionality (AC: 4)
  - [x] Add file input for image upload
  - [x] On file selection, call `POST /files/upload` endpoint
  - [x] Store returned image URL in form state
  - [x] Display image preview after upload
  - [x] Handle upload errors (file too large, invalid format, etc.)
- [x] Implement form submission (AC: 5, 6)
  - [x] Disable submit button until form is valid
  - [x] On submit, construct category payload with all fields
  - [x] Call `POST /categories` via `src/lib/api/categories.ts`
  - [x] Include image URL in payload if uploaded
- [x] Handle API success response (AC: 7)
  - [x] Show toast notification: "¡Categoría registrada exitosamente!"
  - [x] Navigate to category detail page (`/dashboard/categories/[id]`) or list page
  - [x] Use Next.js `useRouter` for navigation
- [x] Handle API error responses (AC: 8)
  - [x] Check for 409 Conflict: display "La categoría ya está registrada"
  - [x] Check for 400 Bad Request: display specific validation errors from backend
  - [x] Show toast or inline error messages
- [x] Add loading state during API call (AC: 9)
  - [x] Show loading spinner on submit button
  - [x] Disable form inputs while submitting
- [x] Add cancel button (AC: 10)
  - [x] "Cancelar" button navigates back to `/dashboard/categories`
  - [x] No API call, no data saved

## Dev Notes

### Tech Stack
[Source: architecture/tech-stack.md]
- **Framework**: Next.js 15.5.4 with App Router
- **Language**: TypeScript 5.9.3 (strict mode)
- **Styling**: Tailwind CSS 4.1.14
- **UI Components**: shadcn/ui (Form, Input, Textarea, Select, Button)
- **Form Management**: React Hook Form (install if not present)
- **Validation**: Zod (install if not present)

### Source Tree / File Locations
[Source: architecture/source-tree.md]
- **Page**: `/src/app/(dashboard)/categories/new/page.tsx`
- **Component**: `/src/components/categories/CategoryForm.tsx`
- **Validation Schema**: `/src/lib/validations/category.schema.ts`
- **API Client**: `/src/lib/api/categories.ts` (add `createCategory()` function)
- **Types**: `/src/lib/types/category.types.ts`

### Data Models
[Source: PRD Epic 4]
**CategoryFormData** (for form state):
```typescript
interface CategoryFormData {
  titulo: string;
  descripcion: string;
  nivelRiesgo: 1 | 2 | 3 | 4;
  senales?: string;
  prevencion: string;
  acciones?: string;
  ejemplos?: string;
  imagen?: string; // Image URL after upload
}
```

**Validation Rules**:
- titulo: required, max 255 chars, unique (backend validation)
- descripcion: required, max 500 chars
- nivelRiesgo: required, one of [1, 2, 3, 4]
- senales: optional, max 500 chars
- prevencion: required, max 500 chars
- acciones: optional, max 500 chars
- ejemplos: optional, max 500 chars
- imagen: optional, valid image file (jpg, png, webp)

### API Specifications
[Source: PRD Epic 4, architecture/tech-stack.md]

**Create Category Endpoint**:
- **Endpoint**: `POST /categories`
- **Base URL**: `NEXT_PUBLIC_API_BASE_URL`
- **Authentication**: JWT token required
- **Request Body**: `CategoryFormData` (JSON)
- **Success Response (201)**: `{ data: Category }`
- **Error Responses**:
  - 409 Conflict: Category title already exists
  - 400 Bad Request: Validation errors
  - 401 Unauthorized: Invalid/missing token

**File Upload Endpoint**:
- **Endpoint**: `POST /files/upload`
- **Request**: multipart/form-data with file
- **Accepted Formats**: jpg, png, webp
- **Success Response (200)**: `{ url: string }` (image URL)
- **Error Responses**:
  - 400 Bad Request: Invalid file format or size
  - 500 Server Error

### Component Specifications
[Source: architecture/source-tree.md, architecture/coding-standards.md]

**CategoryForm Component**:
- Props: `onSubmit: (data: CategoryFormData) => void`, `onCancel: () => void`, `isLoading: boolean`
- Use shadcn/ui form components
- Fields:
  1. Título: `<Input>` (text)
  2. Descripción: `<Textarea>` (multiline)
  3. Nivel de Riesgo: `<Select>` with options:
     - 1: "Muy Bajo"
     - 2: "Bajo"
     - 3: "Medio"
     - 4: "Alto"
  4. Señales: `<Textarea>` (optional)
  5. Prevención: `<Textarea>` (required)
  6. Acciones: `<Textarea>` (optional)
  7. Ejemplos: `<Textarea>` (optional)
  8. Imagen: `<Input type="file">` with preview
- Integrate React Hook Form `useForm` hook with Zod schema
- Display inline validation errors below each field
- Submit button: disabled if form invalid or loading
- Cancel button: always enabled

**Toast Notifications**:
- Use shadcn/ui `toast` or custom `useToast` hook
- Success: "¡Categoría registrada exitosamente!"
- Error: Display specific error message from API

### Coding Standards
[Source: architecture/coding-standards.md]
- TypeScript strict mode
- Use React Hook Form `useForm` hook with Zod resolver
- Use async/await for API calls with try-catch
- Destructure form values and methods from `useForm`
- Use `@/` path alias for imports
- Explicit return types for functions
- Handle loading, success, and error states explicitly

### Validation Schema (Zod)
[Source: architecture/tech-stack.md]
```typescript
// src/lib/validations/category.schema.ts
import { z } from 'zod';

export const categorySchema = z.object({
  titulo: z.string().min(1, "El título es requerido").max(255, "Máximo 255 caracteres"),
  descripcion: z.string().min(1, "La descripción es requerida").max(500, "Máximo 500 caracteres"),
  nivelRiesgo: z.enum(['1', '2', '3', '4'], { required_error: "El nivel de riesgo es requerido" }),
  senales: z.string().max(500, "Máximo 500 caracteres").optional(),
  prevencion: z.string().min(1, "La prevención es requerida").max(500, "Máximo 500 caracteres"),
  acciones: z.string().max(500, "Máximo 500 caracteres").optional(),
  ejemplos: z.string().max(500, "Máximo 500 caracteres").optional(),
  imagen: z.string().url().optional(),
});

export type CategoryFormData = z.infer<typeof categorySchema>;
```

### Testing
[Source: architecture/coding-standards.md]
- **Test Location**: `CategoryForm.test.tsx` (co-located)
- **Framework**: Vitest (Post-MVP)
- **Test Cases**:
  - Form renders with all fields
  - Validation errors display for required fields
  - Submit button disabled when form invalid
  - Form submits with valid data
  - Image upload triggers API call and displays preview
  - Cancel button navigates back

### Project Structure Notes
- This form will be reused for Story 4.4 (Edit Category) with minor modifications (pre-populate fields)
- Consider making CategoryForm generic to accept `initialData` prop for edit mode
- Ensure consistent styling with other forms (login, register, incident evaluation)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None

### Completion Notes List
- Created validation schema with Zod v4 compatibility (using `message` instead of `required_error`)
- Form component designed to be reusable for both create and edit modes
- Image upload integrated with preview and removal functionality
- Mock data implementation included for development/testing
- All TypeScript strict mode requirements met
- Build and lint successful with only pre-existing warnings

### File List
- src/lib/validations/category.schema.ts (new)
- src/components/categories/CategoryForm.tsx (new)
- src/app/(dashboard)/categories/new/page.tsx (new)
- src/lib/api/categories.ts (modified - added createCategory function)
- src/components/ui/textarea.tsx (installed via shadcn)

## QA Results
_To be filled by QA agent_
