# Story 2.5: Incident Status Evaluation

<!-- Powered by BMAD™ Core -->

## Status
Done

---

## Story

**As an** administrator,
**I want** to evaluate incidents and assign status (Pendiente, Aprobado, Rechazado),
**so that** I can approve legitimate reports and reject spam or invalid submissions.

---

## Acceptance Criteria

1.  Incident detail page includes evaluation controls section.
2.  Status dropdown displays current status and allows selection:
    *   Pendiente (1)
    *   Aprobado (2)
    *   Rechazado (3)
3.  Status dropdown only enabled if user is admin (check `is_admin` flag from auth context).
4.  "Guardar Evaluación" button enabled only when the status is changed from its original value.
5.  On button click, call API: `PATCH /admin/incidents/[id]/evaluate` with body `{ id_estatus: [selected_status] }`.
6.  API success response:
    *   Toast notification shows: "Incidente evaluado exitosamente".
    *   Incident detail view updates to show the new status badge without a full page reload.
7.  API error response:
    *   Toast notification shows an error: "Error al evaluar incidente. Intente nuevamente."
8.  Loading state during API call: button shows a spinner and the form is disabled.
9.  Status change is logged for auditing purposes (backend responsibility).

---

## Dev Notes

### Previous Story Insights

- **Component-Based Architecture**: Story 2.4 established a pattern of creating dedicated components for specific pieces of functionality on the incident detail page (e.g., `IncidentDetailDisplay`, `EvidenceGallery`). This story will continue that pattern by creating a new component for the evaluation form.
- **Custom Hooks for Data**: The `useIncident` hook is the central point for fetching and managing the state of a single incident. This story will extend or use this hook to update the incident's state after a successful evaluation.
- **API Layer**: API calls are neatly organized in `src/lib/api/`. This story will add a new function to `src/lib/api/incidents.ts` for the PATCH request.

### Architecture & Implementation Plan

**1. API Client Update**
- **File**: `src/lib/api/incidents.ts` [Source: `docs/architecture/source-tree.md`]
- **Function**: Create a new function `evaluateIncident(id: string, statusId: number): Promise<void>`.
- **Implementation**: This function will make a `PATCH` request to `/admin/incidents/[id]/evaluate` with the body `{ id_estatus: statusId }`. It should handle API errors and re-throw them to be caught by the calling component. [Source: `docs/architecture/coding-standards.md`]

**2. UI Component: `IncidentEvaluationForm`**
- **File**: `src/components/incidents/IncidentEvaluationForm.tsx` (new file) [Source: `docs/architecture/source-tree.md`]
- **Purpose**: A self-contained form for changing an incident's status.
- **Props**:
    - `incident: IncidentDetail` (to get the current status and ID)
    - `onUpdate: (updatedIncident: Partial<IncidentDetail>) => void` (a callback to update the parent page's state)
- **Implementation**:
    - Use `useState` to manage the selected status, initialized with `incident.id_estatus`.
    - Use the `useAuth` hook to get the current user and check the `is_admin` flag.
    - Render a `Card` component from `shadcn/ui` titled "Evaluación de Incidente".
    - Inside, use a `Select` component from `shadcn/ui` for the status dropdown. The dropdown should be disabled if the user is not an admin.
    - The "Guardar Evaluación" `Button` should be disabled if the selected status is the same as the original status or if the form is submitting.
    - On button click, call the `evaluateIncident` API function. Show a loading spinner on the button.
    - Use the `useToast` hook to display success or error notifications. [Source: `docs/architecture/tech-stack.md`]
    - On success, call the `onUpdate` prop with the new status to update the parent component's state.

**3. Page Integration**
- **File**: `src/app/(dashboard)/incidents/[id]/page.tsx` [Source: `docs/architecture/source-tree.md`]
- **Logic**:
    - The page already uses the `useIncident` hook.
    - Add a state update function to the `useIncident` hook or manage the incident state directly on the page to allow for partial updates without re-fetching.
    - Render the new `IncidentEvaluationForm` component, passing the current `incident` data and the `onUpdate` handler.
    - The `onUpdate` handler should update the local incident state, causing the `IncidentStatusBadge` and other details to re-render with the new information.

**4. Type Definition**
- **File**: `src/lib/types/incident.types.ts` [Source: `docs/architecture/source-tree.md`]
- **Review**: Ensure the `IncidentDetail` interface contains `id_estatus` and any other relevant fields. No changes are expected if Story 2.4 was implemented correctly.

---

## Tasks / Subtasks

- [x] **Task 1: Update API Client** (AC: 5)
    - [x] Open `src/lib/api/incidents.ts`.
    - [x] Add and export the `evaluateIncident(id: string, statusId: number)` async function to perform the `PATCH` request.
- [x] **Task 2: Create `IncidentEvaluationForm` Component** (AC: 1, 2, 3, 4, 8)
    - [x] Create the file `src/components/incidents/IncidentEvaluationForm.tsx`.
    - [x] Implement the form with a `Select` dropdown for status and a "Guardar" button as per the Dev Notes.
    - [x] Handle form state (selected status, loading state).
    - [x] Disable the form controls based on admin status and form state.
- [x] **Task 3: Implement API Call and State Update** (AC: 5, 6, 7)
    - [x] In `IncidentEvaluationForm.tsx`, create the `onSubmit` handler.
    - [x] Call the `evaluateIncident` API function within a `try...catch` block.
    - [x] Use the `useToast` hook to show success or error messages.
    - [x] On success, invoke the `onUpdate` prop to pass the new status back to the parent page.
- [x] **Task 4: Integrate Form into Detail Page** (AC: 1)
    - [x] Open `src/app/(dashboard)/incidents/[id]/page.tsx`.
    - [x] Add logic to handle the `onUpdate` callback from the form, allowing the local incident state to be updated.
    - [x] Render the `<IncidentEvaluationForm />` component within the page layout, likely in a sidebar or a dedicated section.
- [x] **Task 5: Verification**
    - [x] Run `npm run dev`.
    - [x] Navigate to an incident detail page.
    - [x] Verify the evaluation form is displayed.
    - [x] Change the status and verify the "Guardar" button becomes enabled.
    - [x] Click save and verify the API is called, a success toast appears, and the status badge updates instantly.
    - [x] Test the error case by forcing the API to fail (e.g., network offline).
    - [x] Verify the form is disabled for non-admin users (if applicable).
    - [x] Run `npm run lint` and `npm run build` to check for errors.

---

## Dev Agent Record

### Agent Model Used
Gemini

### File List
- `src/lib/api/incidents.ts` (Modified)
- `src/components/incidents/IncidentEvaluationForm.tsx` (Created)
- `src/app/(dashboard)/incidents/[id]/page.tsx` (Modified)

### Debug Log References
- Build failed due to incorrect toast import. Corrected `useToast` to `toast` from `sonner`.
- Build failed due to incorrect property name `id_incidente`. Corrected to `id`.
- Build failed due to incorrect `toast` function call. Corrected to use `toast.success()` and `toast.error()`.

### Completion Notes
- The `IncidentEvaluationForm` component was created to handle the status change.
- The incident detail page was updated to use local state to allow for instant UI updates.
- The API client was updated with the `evaluateIncident` function.
- All verification steps passed.