# Story 5.3: Logout Functionality

## Status
Ready for Review
## Story

**As an** administrator,
**I want** to securely log out of the dashboard,
**so that** my session is terminated and no one else can access my account from this device.

## Acceptance Criteria

1. "Cerrar sesión" button added to navigation (sidebar footer or profile dropdown)
2. Button displays logout icon and text "Cerrar sesión"
3. On button click, call auth context `logout()` function:
   - Clear JWT token from localStorage/cookies
   - Reset auth state (`user=null`, `isAuthenticated=false`)
4. After logout, redirect user to `/login` page
5. Toast notification displayed: "Su sesión se ha cerrado correctamente"
6. If backend requires explicit logout endpoint (e.g., `POST /auth/logout` to invalidate token), call it before clearing client state
7. After logout, user cannot access protected routes (redirected to login if they try)
8. No confirmation dialog needed (logout should be immediate)

## Tasks / Subtasks

- [x] Implement logout function in auth context (AC: 3, 6)
  - [x] Locate or create `/src/contexts/AuthContext.tsx` (may already exist from Story 1.2)
  - [x] Add `logout()` function to AuthContext
  - [x] **IMPORTANT: Use mock implementation for now - do not call real backend**
  - [x] Mock logout function:
    - Clear token from localStorage: `localStorage.removeItem('auth_token')`
    - Reset auth state: `setUser(null)`, `setIsAuthenticated(false)`
    - Add console.log to confirm logout triggered
  - [x] Note: Backend `POST /auth/logout` endpoint call will be added during backend integration phase
  - [x] Export logout function from useAuthContext hook
- [x] Connect logout button to logout function (AC: 1, 2)
  - [x] Update Sidebar component from Story 5.2 (`/src/components/layout/Sidebar.tsx`)
  - [x] Import `useAuth()` hook (or equivalent from AuthContext)
  - [x] Replace placeholder onClick with actual logout function call
  - [x] Button already has icon and text "Cerrar sesión" (from Story 5.2)
- [x] Implement redirect after logout (AC: 4)
  - [x] Use Next.js `useRouter()` hook
  - [x] After logout completes, call `router.push('/login')`
  - [x] Ensure navigation happens in Sidebar component or logout function
- [x] Add success toast notification (AC: 5)
  - [x] Import toast from shadcn/ui or use custom toast hook
  - [x] Display toast: "Su sesión se ha cerrado correctamente"
  - [x] Toast should appear before redirect (brief delay if needed)
  - [x] Use success variant (green)
- [x] Verify route protection after logout (AC: 7)
  - [x] **IMPORTANT: Use mock route protection - do not implement real auth middleware yet**
  - [x] Check if middleware or layout already handles protected routes
  - [x] If not exists, create simple client-side check in dashboard layout:
    - Check if token exists in localStorage
    - If no token, redirect to `/login` using `useEffect` in layout
  - [x] Note: Full auth middleware will be implemented during backend integration
  - [x] Test: After logout, navigating to `/dashboard` should redirect to `/login`
- [x] Handle edge cases (AC: 8)
  - [x] No confirmation dialog - logout is immediate
  - [x] Handle logout errors gracefully (if backend call added later)
  - [x] Prevent double-clicking logout button (disable button during logout process)
  - [x] Clear any user-specific data from state/context

## Dev Notes

### User Instructions - CRITICAL
**MOCK IMPLEMENTATION**: The user has explicitly requested that this story use mock data and implementations for frontend testing. DO NOT make real API calls to backend logout endpoint. DO NOT implement full authentication middleware. Use localStorage for token management and client-side route checks. The backend will not be connected until the end of the project. Focus on creating a testable frontend logout flow.

### Tech Stack
[Source: architecture/tech-stack.md]
- **Framework**: Next.js 15.5.4 with App Router
- **Language**: TypeScript 5.9.3 (strict mode)
- **Styling**: Tailwind CSS 4.1.14
- **UI Components**: shadcn/ui (Button, Toast)
- **Icons**: Lucide React (LogOut)
- **Routing**: Next.js `useRouter()` hook
- **State Management**: React Context API (AuthContext)

### Source Tree / File Locations
[Source: architecture/source-tree.md]
- **Auth Context**: `/src/contexts/AuthContext.tsx` (may already exist, update if so)
- **Sidebar Component**: `/src/components/layout/Sidebar.tsx` (update from Story 5.2)
- **Dashboard Layout**: `/src/app/(dashboard)/layout.tsx` (update for route protection check)
- **Custom Hook**: `/src/hooks/useAuth.ts` (may already exist)

### Auth Context Structure
[Source: architecture/coding-standards.md, PRD Epic 1]

**AuthContext Interface** (reference from Story 1.2):
```typescript
interface AuthContextType {
  user: User | null;
  isAuthenticated: boolean;
  login: (email: string, password: string) => Promise<void>;
  logout: () => void;
  loading: boolean;
}

interface User {
  id: string;
  name: string;
  email: string;
  role: string;
}
```

**Mock Logout Function**:
```typescript
const logout = () => {
  // Clear token from localStorage
  localStorage.removeItem('auth_token');

  // Reset auth state
  setUser(null);
  setIsAuthenticated(false);

  // Log for debugging
  console.log('User logged out (mock implementation)');
};
```

### Component Integration

**Sidebar Component Update** (from Story 5.2):
```typescript
// In Sidebar.tsx
import { useAuth } from '@/hooks/useAuth';
import { useRouter } from 'next/navigation';
import { toast } from '@/components/ui/use-toast';

export default function Sidebar() {
  const { logout } = useAuth();
  const router = useRouter();

  const handleLogout = () => {
    logout();
    toast({
      title: "Sesión cerrada",
      description: "Su sesión se ha cerrado correctamente",
      variant: "default", // or "success" if available
    });
    router.push('/login');
  };

  return (
    // ... sidebar content
    <button onClick={handleLogout}>
      <LogOut size={20} />
      Cerrar sesión
    </button>
  );
}
```

### Route Protection Implementation
[Source: User requirements - mock implementation]

**Option A: Client-Side Check in Dashboard Layout**:
```typescript
// In /src/app/(dashboard)/layout.tsx
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';

export default function DashboardLayout({ children }) {
  const router = useRouter();

  useEffect(() => {
    const token = localStorage.getItem('auth_token');
    if (!token) {
      router.push('/login');
    }
  }, [router]);

  return (
    // ... layout content
  );
}
```

**Note**: This is a simplified mock implementation. Full authentication middleware would be implemented during backend integration phase.

### Toast Notification
[Source: architecture/tech-stack.md, PRD requirements]
- Use shadcn/ui Toast component
- Toast should display: "Su sesión se ha cerrado correctamente"
- Success variant (green) or default with success icon
- Auto-dismiss after 3-5 seconds
- Position: top-right (consistent with other toasts in app)

### API Specifications (FOR FUTURE REFERENCE - NOT USED IN THIS STORY)
[Source: PRD Epic 1]
The following endpoint is documented for future integration but MUST NOT be called in this story:
- **Endpoint**: `POST /auth/logout`
- **Purpose**: Invalidate JWT token on backend
- **Implementation**: Will be added during backend integration phase

### Coding Standards
[Source: architecture/coding-standards.md]
- TypeScript strict mode - all functions have explicit return types
- Functional components only
- Props destructuring
- Use async/await for future API calls (logout endpoint)
- Proper error handling with try-catch (for future backend call)
- Clear, descriptive function names: `handleLogout`, `logout`
- Use `useRouter()` from `next/navigation` (not `next/router`)

### Security Considerations
[Source: architecture/coding-standards.md, security best practices]
- Clear all auth-related data on logout:
  - JWT token from localStorage
  - User state from context
  - Any cached user data
- Redirect to login immediately after logout
- Prevent access to protected routes after logout
- Future: Backend should invalidate token (not implemented in this story)
- Future: Consider using httpOnly cookies instead of localStorage (more secure)

### Testing
[Source: architecture/coding-standards.md, PRD requirements]
**Manual Testing for MVP**:
- Click "Cerrar sesión" button in sidebar
- Verify toast notification appears: "Su sesión se ha cerrado correctamente"
- Verify redirect to `/login` page
- Check localStorage - `auth_token` should be removed
- Try navigating to `/dashboard` after logout
- Verify redirect to `/login` (route protection works)
- Verify auth context state reset (user=null, isAuthenticated=false)
- Test double-click on logout button (should not cause errors)
- Test logout from different dashboard pages (incidents, users, categories)

### Notes from Previous Stories
[Source: Story 5.2]
- Sidebar component created in Story 5.2 with placeholder logout button
- Button already has correct styling and icon
- Only need to add onClick handler logic
- User info displayed in sidebar uses mock data (consistent approach)

[Source: Story 1.2]
- AuthContext created in Epic 1 for login functionality
- Check if logout function already exists (likely placeholder)
- Update existing logout function with mock implementation
- Ensure consistency with login flow

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Initial story draft created with mock implementation requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None

### Completion Notes List
- Logout function already existed in AuthContext, confirmed functionality
- Updated Sidebar component to use actual logout function
- Added toast notification using sonner (shadcn/ui replacement for toast)
- Implemented redirect to /login after logout
- Added client-side route protection in dashboard layout
- Logout clears token from localStorage and resets auth state
- Toast message displays successfully before redirect

### File List
- Modified: `/src/components/layout/Sidebar.tsx`
- Modified: `/src/app/(dashboard)/layout.tsx`
- Added: `/src/components/ui/sonner.tsx` (shadcn/ui)
- Referenced: `/src/contexts/AuthContext.tsx` (logout function already exists)

## QA Results
_To be filled by QA agent_
