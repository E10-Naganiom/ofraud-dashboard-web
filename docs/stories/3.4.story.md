# <!-- Powered by BMAD™ Core -->
# Story 3.4: Edit User Profile

## Status
Done

## Story
**As an** administrator,
**I want** to edit user account details including name, email, role, and active status,
**so that** I can update user information and permissions as needed.

## Acceptance Criteria
1.  Clicking the edit icon on a user row in the user list navigates to the edit page: `/dashboard/users/[id]`.
2.  The edit page fetches and displays the data for the specified user. For this frontend-only task, **simulate** this fetch.
3.  The edit form is pre-populated with the simulated user data.
4.  The form reuses the `UserForm` component and includes the following fields:
    -   Nombre (text, required, max 50 chars)
    -   Apellido (text, required, max 50 chars)
    -   Correo electrónico (email, required, unique, max 190 chars)
    -   Es administrador (checkbox for `is_admin` flag)
    -   Cuenta activa (toggle for `is_active` flag)
5.  Password fields are **not** displayed, as password changes are out of scope.
6.  Form validation is handled by the existing Zod schema, adapted for the edit case (e.g., password is not required).
7.  The "Guardar Cambios" (Save Changes) button is disabled until the form is valid and at least one field has been modified.
8.  On submit, **simulate** an API call: `PUT /admin/user/[id]`.
9.  On simulated success:
    -   Display a toast notification: "Usuario actualizado exitosamente (Simulación)".
    -   Navigate back to the user list page (`/dashboard/users`).
10. On simulated error (e.g., user not found, email conflict):
    -   Display an appropriate toast, e.g., "Usuario no encontrado (Simulación)".
11. A loading state is displayed on the submit button during the simulated API call.
12. A "Cancelar" button navigates back to the user list without saving changes.

## Dev Notes
This section contains all relevant technical details extracted from project documentation. The developer agent should not need to read the full architecture documents.

### User Request Override
-   The user has explicitly requested that this story be implemented with a **frontend-only focus using mock data**.
-   The backend is not yet connected. All API calls **must be simulated** using `setTimeout` to mimic network latency.
-   The primary goal is to build and validate the complete UI and logic for the user editing flow.

### Previous Story Insights
-   Story 3.3 established the `UserForm` component and the Zod validation schema (`user.schema.ts`). This story **must reuse and adapt** these existing pieces.
-   The pattern of using `setTimeout` for mocked API calls and `useToast` for notifications should be continued.

### Data Models & Validation
-   The existing `User` type from `src/lib/types/user.types.ts` should be used.
-   The Zod validation schema in `src/lib/validations/user.schema.ts` must be adapted for the edit form. Create a new exported schema, e.g., `editUserSchema`, that omits the password fields.
-   [Source: `docs/architecture/coding-standards.md`, `docs/prd/epic-3-user-administration-profile-management.md`]

### API Specifications (Mocked)
-   **Fetch User**: On page load, simulate a `GET /admin/user/[id]` request. Create a mock user object to populate the form. You can use the user ID from the URL to "select" a mock user from a small, predefined array.
-   **Update User**: The form submission should trigger a function that **simulates** a `PUT` request to `/admin/user/[id]`. This function should use `setTimeout` (e.g., 500ms).
-   **Simulate States**: The mock logic should handle:
    -   Success: Resolve the timeout and show a success toast.
    -   Not Found: If the ID is, for example, `0` or `'not-found'`, simulate a 404 error with a toast.
-   [Source: User Request Override, `docs/prd/epic-3-user-administration-profile-management.md`]

### Component Specifications
-   **Form Component**: Reuse and enhance `src/components/users/UserForm.tsx`.
    -   It may need a new prop, e.g., `mode: 'create' | 'edit'`, to adjust its behavior (like hiding password fields).
    -   It should accept an optional `initialData` prop to pre-populate the form fields.
-   **UI Components**: Continue using `shadcn/ui` components (`Input`, `Checkbox`, `Switch`, `Button`, `Form`).
-   **State Management**: Use `React Hook Form` with the `zodResolver` for the `editUserSchema`.
-   **Notifications**: Use the `useToast` hook from `shadcn/ui` for all user feedback.
-   [Source: `docs/architecture/tech-stack.md`, `docs/architecture/source-tree.md`]

### File Locations
-   **Edit Page**: `src/app/(dashboard)/users/[id]/page.tsx`. Note: The epic mentioned `.../[id]/edit`, but the canonical project structure in `source-tree.md` designates `.../[id]/page.tsx` as the edit page. We will follow the `source-tree.md`.
-   **Form Component**: `src/components/users/UserForm.tsx` (to be modified).
-   **Validation Schema**: `src/lib/validations/user.schema.ts` (to be modified).
-   [Source: `docs/architecture/source-tree.md`]

## Tasks / Subtasks
-   [x] **Task 1: Update Validation Schema** (AC: 6)
    -   [x] In `src/lib/validations/user.schema.ts`, create and export a new schema named `editUserSchema`.
    -   [x] This schema should be based on the create schema but omit `password` and `confirmPassword`.

-   [x] **Task 2: Enhance `UserForm` Component** (AC: 4, 5, 7)
    -   [x] Modify `src/components/users/UserForm.tsx` to accept `initialData?: User` and `mode: 'create' | 'edit'`.
    -   [x] Use the `mode` prop to conditionally render the password fields. They should NOT be visible when `mode` is `'edit'`.
    -   [x] When `initialData` is provided, use `form.reset(initialData)` in a `useEffect` to populate the form.
    -   [x] The submit button's disabled logic should be updated for edit mode: `!form.formState.isValid || !form.formState.isDirty`.

-   [x] **Task 3: Create the User Edit Page** (AC: 1, 2, 3)
    -   [x] Create the page file `src/app/(dashboard)/users/[id]/page.tsx`.
    -   [x] Extract the user `id` from the URL parameters.
    -   [x] Implement the **mocked fetch logic**: Create a state for the user data and use a `useEffect` with `setTimeout` to simulate fetching the user. If the `id` is invalid (e.g., '0'), show an error toast and redirect.
    -   [x] Render the `UserForm` component, passing the fetched mock data as `initialData` and the `mode='edit'`.
    -   [x] Include a page header, e.g., "Editar Usuario".

-   [x] **Task 4: Implement Mocked Update Logic** (AC: 8, 9, 10, 11)
    -   [x] In the `[id]/page.tsx`, create the `onSubmit` handler for the `UserForm`.
    -   [x] This handler will manage a `loading` state.
    -   [x] Inside, implement the simulated `PUT` request using `setTimeout`.
    -   [x] On success, show the success toast and navigate the user back to `/dashboard/users`.
    -   [x] Handle potential mock errors (e.g., if trying to change email to an already "existing" mock email).

-   [x] **Task 5: Link from User List** (AC: 1)
    -   [x] Ensure the "Acciones" column in the user list table on the `/users` page has an edit icon/button.
    -   [x] This button must link to the correct edit page, e.g., `/dashboard/users/1`.

## Testing
-   Manual testing is required. Verify that the form pre-populates correctly, validation works, the submit button is disabled appropriately, and the mocked submission flow (success and error) behaves as expected.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-12 | 1.0 | Initial draft of story 3.4 | Bob (Scrum Master) |
| 2025-10-12 | 1.1 | Implemented user edit page and form logic with mock data. | James (Developer) |
