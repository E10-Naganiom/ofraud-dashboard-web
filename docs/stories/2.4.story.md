# Story 2.4: Incident Detail View Page

<!-- Powered by BMAD™ Core -->

## Status
Done

---

## Story

**As an** administrator,
**I want** to view the complete details of an incident including evidence, user information, and evaluation controls,
**so that** I can make informed decisions about approving or rejecting the report.

---

## Acceptance Criteria

1.  Incident detail page created at `/dashboard/incidents/[id]` dynamic route.
2.  On page load, fetch incident details via `GET /admin/incidents/[id]`.
3.  Display full incident information:
    *   Título
    *   Descripción (full text, not truncated)
    *   Categoría (display full category name and description)
    *   Nombre del atacante (if provided, otherwise "No especificado")
    *   Teléfono (if provided)
    *   Correo electrónico del atacante (if provided)
    *   Usuario de red social (if provided)
    *   Red social (if provided)
    *   Fecha de creación (formatted "DD/MM/YYYY HH:mm")
    *   Fecha de actualización (formatted)
    *   Estado actual (badge with color)
    *   Supervisor asignado (display supervisor name if assigned, otherwise "Sin asignar")
    *   Es anónimo (display "Sí" or "No")
4.  Display reporter information:
    *   Fetch user details via `id_usuario` (may require separate API call to `/admin/user/[id_usuario]`).
    *   Show: Nombre, Apellido, Correo electrónico.
5.  Display evidence images:
    *   Fetch evidence via `evidencia` table (URLs).
    *   Display images in gallery or list (clickable to open full-size in modal or new tab).
    *   If no evidence, display "Sin evidencia adjunta".
6.  Loading state shown while fetching data (e.g., skeleton loader).
7.  Error handling: if incident not found (404), display "Incidente no encontrado" and a back button.
8.  A "Volver a lista" button navigates back to `/dashboard/incidents`.

---

## Dev Notes

### Previous Story Insights

- **Filtering Components**: Story 2.3 introduced `IncidentFilters.tsx` and the `useCategories` hook. While not directly used here, it establishes a pattern of creating dedicated components and hooks for specific domains, which this story will follow.
- **API and Type Structure**: The creation of `src/lib/api/categories.ts` and `src/lib/types/category.types.ts` sets the precedent for how new API clients and type definitions should be organized.

### Architecture & Implementation Plan

**1. Dynamic Route and Page Structure**
- **File**: Create the page at `src/app/(dashboard)/incidents/[id]/page.tsx`. This will be a client component (`'use client'`). [Source: `docs/architecture/source-tree.md`]
- **Purpose**: This file will be responsible for extracting the `id` from the URL, fetching data using a custom hook, and managing loading/error states.

**2. Data Fetching & State Management**
- **API Client**:
    - **File**: `src/lib/api/incidents.ts`
    - **Function**: Add a new function `export async function getIncidentById(id: string): Promise<IncidentDetail>`. This function will call the `GET /admin/incidents/[id]` endpoint. [Source: `docs/architecture/source-tree.md`]
- **Type Definition**:
    - **File**: `src/lib/types/incident.types.ts`
    - **Interface**: Define a new `IncidentDetail` interface that includes all fields from the Acceptance Criteria (e.g., `titulo`, `descripcion`, `categoria`, `atacante`, `evidencia: { url: string }[]`, etc.). This will be more comprehensive than the `Incident` type used for the list view. [Source: `docs/architecture/coding-standards.md`]
- **Custom Hook**:
    - **File**: `src/hooks/useIncident.ts` (new file)
    - **Hook**: Create a `useIncident(id: string)` hook.
    - **Functionality**: This hook will encapsulate the logic for fetching a single incident using `getIncidentById`. It should manage `data`, `loading`, and `error` states. [Source: `docs/architecture/coding-standards.md`]

**3. UI Components**
- **`IncidentDetailDisplay.tsx` Component**:
    - **File**: `src/components/incidents/IncidentDetailDisplay.tsx` (new file)
    - **Purpose**: This component will be responsible for rendering the main body of the incident details. It will receive the `IncidentDetail` object as a prop.
    - **Implementation**: Use `Card`, `CardHeader`, `CardContent`, `Badge` from `shadcn/ui` to structure the layout. Display all fields as specified in AC 3. Use the `cn` utility for conditional classes. [Source: `docs/architecture/source-tree.md`, `docs/architecture/tech-stack.md`]
- **`EvidenceGallery.tsx` Component**:
    - **File**: `src/components/incidents/EvidenceGallery.tsx` (new file)
    - **Purpose**: To display a gallery of evidence images.
    - **Props**: It will accept an array of evidence objects (e.g., `{ url: string }[]`).
    - **Implementation**: Map over the evidence array and render images. Use the `Dialog` component from `shadcn/ui` to show a full-sized image when an evidence thumbnail is clicked. If the array is empty, display "Sin evidencia adjunta". [Source: `docs/architecture/tech-stack.md`]
- **`ReporterInfoCard.tsx` Component**:
    - **File**: `src/components/users/ReporterInfoCard.tsx` (new file)
    - **Purpose**: To display the information of the user who reported the incident.
    - **Props**: It will accept the reporter's user object.
    - **Implementation**: This may require a separate API call inside the `useIncident` hook or on the page level to fetch user details if they are not included in the main incident response. Display the user's name and email within a `Card`. [Source: `docs/architecture/source-tree.md`]

**4. Page Integration**
- **File**: `src/app/(dashboard)/incidents/[id]/page.tsx`
- **Logic**:
    - Use `useParams` from `next/navigation` to get the incident `id`.
    - Call the `useIncident(id)` hook to get data, loading, and error states.
    - Render a `LoadingSpinner` component if `loading` is true. [Source: `docs/architecture/source-tree.md`]
    - Render an `ErrorMessage` component if `error` is present (especially for 404 cases).
    - If data is available, render the main layout including `IncidentDetailDisplay`, `ReporterInfoCard`, and `EvidenceGallery`.
    - Include a `Button` with a `Link` or `useRouter` to navigate back to `/dashboard/incidents`.

---

## Tasks / Subtasks

- [x] **Task 1: Update Types** (AC: 3, 4, 5)
    - [x] Open `src/lib/types/incident.types.ts`.
    - [x] Define and export the `IncidentDetail` interface with all required fields (including nested objects for category, user, evidence, etc.).
- [x] **Task 2: Update API Client** (AC: 2)
    - [x] Open `src/lib/api/incidents.ts`.
    - [x] Implement and export the `getIncidentById(id: string)` async function.
- [x] **Task 3: Create `useIncident` Hook** (AC: 2, 6, 7)
    - [x] Create file `src/hooks/useIncident.ts`.
    - [x] Implement the `useIncident` custom hook to fetch a single incident by ID, managing data, loading, and error states.
- [x] **Task 4: Create UI Components** (AC: 3, 4, 5)
    - [x] Create `src/components/incidents/IncidentDetailDisplay.tsx` to show the main incident data.
    - [x] Create `src/components/incidents/EvidenceGallery.tsx` to display evidence with a modal for full-size view.
    - [x] Create `src/components/users/ReporterInfoCard.tsx` to show the reporter's details.
- [x] **Task 5: Build the Dynamic Page** (AC: 1, 6, 7, 8)
    - [x] Create the page file `src/app/(dashboard)/incidents/[id]/page.tsx`.
    - [x] Use `useParams` to get the `id`.
    - [x] Use the `useIncident` hook to fetch data.
    - [x] Implement the loading and error states.
    - [x] Compose the UI using the components created in Task 4.
    - [x] Add a "Volver a lista" button that navigates to the incidents list.
- [x] **Task 6: Verification**
    - [x] Run `npm run dev` and navigate to an incident detail page (e.g., `/dashboard/incidents/1`).
    - [x] Verify all information from the ACs is displayed correctly.
    - [x] Test the loading state.
    - [x] Test the error state by navigating to an invalid incident ID.
    - [x] Test the evidence gallery modal.
    - [x] Ensure the "Back" button works.
    - [x] Run `npm run lint` and `npm run build` to check for errors.

---

## Dev Agent Record

### File List

- `src/lib/types/incident.types.ts` (modified)
- `src/lib/api/incidents.ts` (modified)
- `src/hooks/useIncident.ts` (created)
- `src/components/incidents/IncidentDetailDisplay.tsx` (created)
- `src/components/incidents/EvidenceGallery.tsx` (created)
- `src/components/users/ReporterInfoCard.tsx` (created)
- `src/app/(dashboard)/incidents/[id]/page.tsx` (created)
- `package.json` (modified)
- `package-lock.json` (modified)
