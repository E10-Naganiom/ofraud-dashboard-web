# Story 2.6: Supervisor Assignment

## Status
Done

## Story
**As a** administrator,
**I want** to assign a supervisor (admin user) to an incident,
**so that** accountability is clear and workload can be distributed among admins.

## Acceptance Criteria
1. Incident detail page includes supervisor assignment dropdown.
2. Dropdown populated with all admin users fetched from `GET /admin/user/list` filtered by `is_admin=true`.
3. Dropdown options display: "Nombre Apellido" of each admin.
4. Default option: "Sin asignar" (supervisor=null).
5. Current supervisor pre-selected in dropdown (if incident already has supervisor assigned).
6. When supervisor changed, update state but do not immediately save (save on "Guardar Evaluación" button click).
7. "Guardar Evaluación" button saves both status and supervisor changes via `PATCH /admin/incidents/[id]/evaluate` with body `{ id_estatus: [status], supervisor: [selected_admin_id] }`.
8. API success response updates incident view with new supervisor name.
9. If API returns error, display: "Error al asignar supervisor".

## Dev Agent Record

### Agent Model Used
Gemini

### File List
- `src/lib/types/user.types.ts` (Created)
- `src/lib/api/users.ts` (Created)
- `src/components/incidents/SupervisorDropdown.tsx` (Created)
- `src/lib/api/incidents.ts` (Modified)
- `src/components/incidents/IncidentEvaluationForm.tsx` (Modified)
- `src/lib/types/incident.types.ts` (Modified)
- `src/lib/mock/data.ts` (Modified)
- `src/lib/api/auth.ts` (Modified)
- `src/lib/types/auth.types.ts` (Modified)
- `src/app/(auth)/register/page.tsx` (Modified)
- `src/lib/validations/auth.schema.ts` (Modified)

### Completion Notes
- Created the `SupervisorDropdown` component to allow selection of an admin user.
- Added `getAdminUsers` function to fetch a list of administrators.
- Integrated the supervisor selection into the `IncidentEvaluationForm`.
- Updated the `evaluateIncident` API call to include the selected supervisor.
- Corrected multiple type inconsistencies across the application that were discovered during the build process, making the data models for users and incidents more robust.

## Tasks / Subtasks
- [x] **Task 1: Create Supervisor Dropdown Component** (AC: 1, 3, 4)
    - [x] Create a new component `SupervisorDropdown.tsx` in `src/components/incidents/`.
    - [x] The component should use the `Select` component from `shadcn/ui`.
    - [x] It should accept a list of admin users and the current supervisor ID as props.
    - [x] The default option should be "Sin asignar".
    - [x] Options should display the full name of the admin.
- [x] **Task 2: Fetch Admin Users** (AC: 2)
    - [x] In the `useIncidents` hook or on the incident detail page, create a function to fetch admin users from `GET /admin/user/list?is_admin=true`.
    - [x] Store the list of admins in the component's state.
    - [x] Pass the admin list to the `SupervisorDropdown` component.
    - [x] [Source: `docs/architecture/source-tree.md`] API calls should be managed in `src/lib/api/users.ts`.
- [x] **Task 3: Integrate Dropdown into Incident Detail Page** (AC: 1, 5)
    - [x] Add the `SupervisorDropdown` component to the `[id]/page.tsx` file under `src/app/(dashboard)/incidents/`.
    - [x] The dropdown should be placed within the `IncidentEvaluationForm` or a similar container.
    - [x] Pass the current incident's supervisor ID to pre-select the correct admin.
- [x] **Task 4: Manage State for Supervisor Selection** (AC: 6)
    - [x] On the incident detail page, create a state variable to hold the selected supervisor ID.
    - [x] The `SupervisorDropdown`'s `onValueChange` should update this state.
    - [x] Ensure the "Guardar Evaluación" button is enabled when the selection changes.
- [x] **Task 5: Update Evaluation Logic** (AC: 7, 8, 9)
    - [x] Modify the `handleSaveEvaluation` function in the incident detail page.
    - [x] The `PATCH` request to `/admin/incidents/[id]/evaluate` must now include the `supervisor` field with the selected admin ID.
    - [x] On success, update the local incident state to show the new supervisor's name.
    - [x] Display a toast notification on success: "Supervisor asignado exitosamente".
    - [x] On error, display an error message: "Error al asignar supervisor".
    - [x] [Source: `docs/architecture/coding-standards.md`] Use `axios` for API calls and handle errors gracefully.

## Dev Notes

### Architecture & Code Structure
*   **Component Location**: The new `SupervisorDropdown.tsx` component should be created in `src/components/incidents/`. [Source: `docs/architecture/source-tree.md`]
*   **API Calls**: The new API call to fetch admin users should be added to `src/lib/api/users.ts`. The existing `evaluate` call in `src/lib/api/incidents.ts` will be used. [Source: `docs/architecture/source-tree.md`]
*   **State Management**: Use React's `useState` hook within the incident detail page (`src/app/(dashboard)/incidents/[id]/page.tsx`) to manage the selected supervisor. For fetching the list of admins, consider adding it to the `useIncidents` hook if it's not already there. [Source: `docs/architecture/coding-standards.md`]
*   **UI Components**: Use `Select` from `shadcn/ui` for the dropdown. [Source: `docs/architecture/tech-stack.md`]

### Naming Conventions
*   **Component**: `SupervisorDropdown.tsx` (PascalCase)
*   **Hook function**: `useAdminUsers` or similar if a new hook is created.
*   **API function**: `getAdminUsers` in `src/lib/api/users.ts`.
*   **Variables**: `selectedSupervisorId`, `adminUsers`, `isSupervisorLoading`.

### Error Handling
*   Handle the API call to fetch admin users gracefully. Show a loading state while fetching and an error message if it fails.
*   The `evaluate` call should handle and display specific errors related to supervisor assignment as per the acceptance criteria.

### Data Models
*   No specific guidance found in architecture docs for `data-models.md`. The developer will need to infer the `AdminUser` type from the API response of `GET /admin/user/list`. It should contain at least `id`, `nombre`, and `apellido`.

### Frontend Architecture
*   No specific guidance found in `frontend-architecture.md`, `components.md`, or `core-workflows.md`. The implementation should follow the existing patterns in the incident detail page.

## Testing
*   **Unit Tests**: No testing framework is set up yet (Post-MVP). When implemented, a test file `SupervisorDropdown.test.tsx` should be created.
*   **Manual Tests**:
    1. Verify the dropdown populates with admin users.
    2. Verify the current supervisor is pre-selected.
    3. Verify changing the supervisor enables the save button.
    4. Verify saving updates the supervisor and status correctly.
    5. Verify an error message is shown if the API call fails.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-08 | 1.0 | Initial draft | Bob (Scrum Master) |

